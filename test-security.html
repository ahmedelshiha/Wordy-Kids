<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Test - Password Hashing Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 4px solid #007bff;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîí Wordy Kids Security Test</h1>
        <p>This test verifies that passwords are being hashed securely and not stored in plaintext.</p>
        
        <button onclick="runSecurityTests()">üöÄ Run Security Tests</button>
        <button onclick="clearTestData()">üßπ Clear Test Data</button>
        <button onclick="checkExistingUsers()">üë• Check Existing Users</button>
        
        <div id="results"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-container ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function clearResults() {
            results.innerHTML = '';
        }

        // Security utility functions (same as in the app)
        const SecurityUtils = {
            generateSalt: () => {
                return CryptoJS.lib.WordArray.random(128/8).toString();
            },

            hashPassword: (password, salt) => {
                return CryptoJS.PBKDF2(password, salt, {
                    keySize: 512/32,
                    iterations: 10000
                }).toString();
            },

            verifyPassword: (password, storedHash, salt) => {
                const hash = SecurityUtils.hashPassword(password, salt);
                return hash === storedHash;
            },

            generateSecureId: () => {
                return CryptoJS.lib.WordArray.random(16).toString();
            }
        };

        function runSecurityTests() {
            clearResults();
            log('<h2>üîç Running Security Tests...</h2>');

            try {
                // Test 1: Password Hashing
                log('<h3>Test 1: Password Hashing Function</h3>');
                const testPassword = 'TestPassword123';
                const salt = SecurityUtils.generateSalt();
                const hash = SecurityUtils.hashPassword(testPassword, salt);
                
                log(`Password: "${testPassword}"`, 'info');
                log(`Salt: "${salt}"`, 'info');
                log(`Hash: "${hash}"`, 'info');
                
                if (hash && hash.length > 20 && hash !== testPassword) {
                    log('‚úÖ Password hashing is working correctly!', 'success');
                } else {
                    log('‚ùå Password hashing failed!', 'error');
                }

                // Test 2: Password Verification
                log('<h3>Test 2: Password Verification</h3>');
                const isValid = SecurityUtils.verifyPassword(testPassword, hash, salt);
                const isInvalid = SecurityUtils.verifyPassword('WrongPassword', hash, salt);
                
                if (isValid && !isInvalid) {
                    log('‚úÖ Password verification is working correctly!', 'success');
                } else {
                    log('‚ùå Password verification failed!', 'error');
                }

                // Test 3: Create Test User with Secure Storage
                log('<h3>Test 3: Secure User Storage</h3>');
                const testUser = {
                    id: SecurityUtils.generateSecureId(),
                    name: 'Test User',
                    email: 'test@security.com',
                    age: 10,
                    passwordHash: hash,
                    salt: salt,
                    createdAt: new Date().toISOString(),
                    isTestUser: true
                };

                // Save to localStorage
                const existingUsers = JSON.parse(localStorage.getItem('wordAdventureUsers') || '[]');
                const updatedUsers = existingUsers.filter(u => !u.isTestUser); // Remove old test users
                updatedUsers.push(testUser);
                localStorage.setItem('wordAdventureUsers', JSON.stringify(updatedUsers));

                log('‚úÖ Test user created with secure password storage!', 'success');
                log(`<pre>${JSON.stringify(testUser, null, 2)}</pre>`);

                // Test 4: Verify Secure Storage
                log('<h3>Test 4: Verify Secure Storage</h3>');
                const storedUsers = JSON.parse(localStorage.getItem('wordAdventureUsers') || '[]');
                const testUserStored = storedUsers.find(u => u.email === 'test@security.com');
                
                if (testUserStored && testUserStored.passwordHash && testUserStored.salt && !testUserStored.password) {
                    log('‚úÖ User data is stored securely - no plaintext password found!', 'success');
                    
                    // Test if we can verify the stored password
                    const canVerify = SecurityUtils.verifyPassword(testPassword, testUserStored.passwordHash, testUserStored.salt);
                    if (canVerify) {
                        log('‚úÖ Stored password can be verified correctly!', 'success');
                    } else {
                        log('‚ùå Cannot verify stored password!', 'error');
                    }
                } else {
                    log('‚ùå User data is not stored securely!', 'error');
                }

                // Test 5: Check for Vulnerable Users
                log('<h3>Test 5: Scan for Vulnerable Users</h3>');
                const vulnerableUsers = storedUsers.filter(u => u.password && !u.passwordHash);
                
                if (vulnerableUsers.length === 0) {
                    log('‚úÖ No vulnerable users found - all passwords are hashed!', 'success');
                } else {
                    log(`‚ö†Ô∏è Found ${vulnerableUsers.length} users with plaintext passwords!`, 'warning');
                    log(`Vulnerable emails: ${vulnerableUsers.map(u => u.email).join(', ')}`, 'warning');
                }

                // Final Summary
                log('<div class="status success"><h3>üéâ Security Test Summary</h3><p>‚úÖ Password hashing is implemented and working correctly!<br/>‚úÖ Passwords are stored securely with salt and PBKDF2 hashing<br/>‚úÖ No plaintext passwords detected in new user creation</p></div>');

            } catch (error) {
                log(`‚ùå Security test failed with error: ${error.message}`, 'error');
                console.error('Security test error:', error);
            }
        }

        function clearTestData() {
            const users = JSON.parse(localStorage.getItem('wordAdventureUsers') || '[]');
            const filteredUsers = users.filter(u => !u.isTestUser);
            localStorage.setItem('wordAdventureUsers', JSON.stringify(filteredUsers));
            log('üßπ Test user data cleared!', 'info');
        }

        function checkExistingUsers() {
            clearResults();
            log('<h2>üë• Existing Users Security Check</h2>');
            
            const users = JSON.parse(localStorage.getItem('wordAdventureUsers') || '[]');
            
            if (users.length === 0) {
                log('‚ÑπÔ∏è No users found in localStorage', 'info');
                return;
            }

            log(`Found ${users.length} users in storage:`, 'info');

            users.forEach((user, index) => {
                const isSecure = user.passwordHash && user.salt && !user.password;
                const isVulnerable = user.password && !user.passwordHash;
                
                if (isSecure) {
                    log(`‚úÖ User ${index + 1} (${user.email || 'no email'}): SECURE - Password is hashed`, 'success');
                } else if (isVulnerable) {
                    log(`üö® User ${index + 1} (${user.email || 'no email'}): VULNERABLE - Password is in plaintext!`, 'error');
                } else {
                    log(`‚ö†Ô∏è User ${index + 1} (${user.email || 'no email'}): UNKNOWN - Unusual password storage`, 'warning');
                }
            });

            const secureCount = users.filter(u => u.passwordHash && u.salt && !u.password).length;
            const vulnerableCount = users.filter(u => u.password && !u.passwordHash).length;

            if (vulnerableCount > 0) {
                log(`<div class="status error"><h3>üö® SECURITY ALERT</h3><p>${vulnerableCount} users have plaintext passwords that need to be migrated!</p></div>`);
            } else {
                log(`<div class="status success"><h3>üõ°Ô∏è SECURITY STATUS: GOOD</h3><p>All ${secureCount} users have secure password storage!</p></div>`);
            }
        }

        // Auto-run test on page load
        window.addEventListener('load', () => {
            log('<div class="status info">üîí Security test page loaded. Click "Run Security Tests" to verify password hashing implementation.</div>');
        });
    </script>
</body>
</html>
